{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="products-container">
    <header class="products-header">
        <div class="header-actions">
            <form class="search-form" method="GET">
                <input type="text" name="q" placeholder="Search products..."
                       value="{{ request.GET.q }}">
                <button type="submit">
                    <img src="{% static 'icons/search.svg' %}" alt="Search">
                </button>
            </form>
        </div>
    </header>

    <section class="searching-section">
        <div class="category-tags">
            {% for category in categories %}
                <a href="?category={{ category.name }}"
                   class="category-tag {% if request.GET.category == category.name %}active{% endif %}">
                    {{ category.name }}
                </a>
            {% endfor %}
        </div>
    </section>

    <div class="products-layout">
        <aside class="filters-sidebar">
            <h3>Filters</h3>
            <form method="GET" class="filter-form">
                <input type="hidden" name="q" value="{{ request.GET.q }}">
                <input type="hidden" name="category" value="{{ request.GET.category }}">

                <div class="filter-group">
                    <label>Price Range (₦)</label>
                    <div class="price-inputs">
                        <input type="number" name="min_price"
                               placeholder="Min" value="{{ request.GET.min_price }}">
                        <input type="number" name="max_price"
                               placeholder="Max" value="{{ request.GET.max_price }}">
                    </div>
                </div>

                <div class="filter-group">
                    <label>Brand</label>
                    <select name="brand">
                        <option value="">All Brands</option>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}"
                            {% if request.GET.brand == brand.id|stringformat:"s" %}selected{% endif %}>
                            {{ brand.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit" class="apply-filters">Apply Filters</button>
                <a href="{% url 'product_list' %}" class="clear-filters">Clear All</a>
            </form>
        </aside>

        <main class="products-main">
            <div class="products-grid">
                {% for product in products %}
                <div class="product-card">
                    {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.title }}" loading="lazy">
                    {% else %}
                    <div class="image-placeholder"></div>
                    {% endif %}
                    <div class="product-info">
                        <h3><a href="{% url 'product_detail' product.pk %}">{{ product.title }}</a></h3>
                        <p class="price">₦{{ product.price }}</p>
                        <p class="description">{{ product.description|truncatechars:100 }}</p>

                        <!-- Save Button with proper state management -->
                     <button class="wishlist-toggle {% if product.id in saved_product_ids %}active{% endif %}"
            data-product-id="{{ product.id }}"
            data-init-state="{% if product.id in saved_product_ids %}saved{% else %}unsaved{% endif %}">
        <i class="{% if product.id in saved_product_ids %}fas{% else %}far{% endif %} fa-heart"></i>
    </button>
                    </div>
                </div>
                {% empty %}
                <div class="no-results">
                    <p>No products found matching your criteria</p>
                </div>
                {% endfor %}
            </div>

            {% if products.has_next %}
            <div class="load-more">
                <button class="load-more-btn" data-next-page="{{ products.next_page_number }}">
                    Load More
                </button>
            </div>
            {% endif %}
        </main>
    </div>
</div>

<style>
    .wishlist-toggle {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.5rem;
    color: #ccc;
    transition: all 0.3s ease;
}

.wishlist-toggle.active,
.wishlist-toggle:hover {
    color: #ff6b6b;
}

.wishlist-toggle:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

    /* other styles */
    .products-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .search-form {
        display: flex;
        align-items: center;
    }

    .search-form input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 8px;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }

    .product-card {
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    .product-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .product-info {
        padding: 15px;
    }

    .price {
        font-weight: bold;
        color: #333;
        margin: 8px 0;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Save/Unsave functionality
    // Initialize all wishlist buttons
    document.querySelectorAll('.wishlist-toggle').forEach(button => {
        const initialState = button.dataset.initState;
        const icon = button.querySelector('i');

        // Set initial state from data attribute
        if (initialState === 'saved') {
            button.classList.add('active');
            icon.classList.replace('far', 'fas');
        } else {
            button.classList.remove('active');
            icon.classList.replace('fas', 'far');
        }
    });

    // Handle toggle clicks
    document.querySelectorAll('.wishlist-toggle').forEach(button => {
        button.addEventListener('click', async function() {
            const productId = this.dataset.productId;
            const icon = this.querySelector('i');

            // Visual feedback
            this.disabled = true;
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`/wishlist/toggle/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Update UI based on action
                    if (data.action === 'added') {
                        this.classList.add('active');
                        icon.classList.replace('far', 'fas');
                    } else {
                        this.classList.remove('active');
                        icon.classList.replace('fas', 'far');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update wishlist');
            } finally {
                this.disabled = false;
                this.innerHTML = originalHTML;
                // Ensure correct icon is shown
                const newIcon = this.querySelector('i');
                newIcon.className = this.classList.contains('active') ? 'fas fa-heart' : 'far fa-heart';
            }
        });
    });

    // Load more products with AJAX
    const loadMoreBtn = document.querySelector('.load-more-btn');
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', async function() {
            const nextPage = this.dataset.nextPage;
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            this.parentElement.appendChild(spinner);
            this.disabled = true;

            try {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('page', nextPage);

                const response = await fetch(`${window.location.pathname}?${urlParams.toString()}`);
                if (!response.ok) throw new Error('Network response was not ok');

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Append new products
                const newProducts = doc.querySelector('.products-grid').innerHTML;
                document.querySelector('.products-grid').insertAdjacentHTML('beforeend', newProducts);

                // Update load more button
                const newLoadMoreBtn = doc.querySelector('.load-more-btn');
                if (newLoadMoreBtn) {
                    this.dataset.nextPage = newLoadMoreBtn.dataset.nextPage;
                } else {
                    this.parentElement.remove();
                }
            } catch (error) {
                console.error('Error loading more products:', error);
                alert('Failed to load more products. Please try again.');
            } finally {
                spinner.remove();
                this.disabled = false;
            }
        });
    }

    // Submit filter form when any filter changes
    document.querySelectorAll('.filter-form input, .filter-form select').forEach(element => {
        element.addEventListener('change', function() {
            this.form.submit();
        });
    });

    // Lazy load images
    if ('IntersectionObserver' in window) {
        const lazyImages = document.querySelectorAll('img[loading="lazy"]');
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src;
                    imageObserver.unobserve(img);
                }
            });
        });

        lazyImages.forEach(img => {
            imageObserver.observe(img);
        });
    }
});
</script>
{% endblock %}
